# Define the name of the workflow
name: Ruff Linter

# Trigger the workflow on pull requests
on:
  push:
    branches: ["**"]

# Set permissions for the workflow
permissions:
  contents: write

# Define the jobs to be run in the workflow
jobs:
  lint:
    # Specify the environment for the job
    runs-on: ubuntu-latest
    steps:
      # Step to checkout the code from the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Step to use the system's pre-installed Python for faster execution
      - name: Use system Python (faster)
        run: |
          echo "Using pre-installed Python: $(python --version)"

      # Step to cache Python packages to speed up subsequent runs
      - name: Cache Python packages
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-ruff-${{ hashFiles('.github/workflows/ruff.yml') }}
          restore-keys: |
            ${{ runner.os }}-pip-ruff-

      # Step to install Ruff using the cached packages
      - name: Install Ruff (cached)
        run: pip install --cache-dir ~/.cache/pip ruff

      # Step to automatically fix formatting issues in the code
      - name: Auto-fix formatting issues
        run: ruff format .

      # Step to automatically fix lint issues in the code
      - name: Auto-fix lint issues
        run: ruff check --fix --no-cache --output-format=concise

      # Step to commit and push any fixes made by Ruff
      - name: Commit & push fixes (if any)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .

          # Check if there are any changes to commit
          git diff --quiet && git diff --staged --quiet || git commit -m "Apply Ruff auto-fixes"

          # Fetch latest changes and rebase (otherwise branch is out of sync with the PR)
          git fetch origin ${GITHUB_HEAD_REF}
          git rebase origin/${GITHUB_HEAD_REF}

          # Push the changes to the pull request branch
          git push origin HEAD:${GITHUB_HEAD_REF}

      # Step to run Ruff and fail the job if any issues remain
      - name: Run Ruff and fail if issues remain
        run: ruff check --no-cache --output-format=concise
